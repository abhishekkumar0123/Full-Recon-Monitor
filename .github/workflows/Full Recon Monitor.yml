name: Full Recon Monitor

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  recon:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt update
          sudo apt install -y jq nmap libpcap-dev
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/tomnomnom/assetfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          go install github.com/projectdiscovery/tlsx/cmd/tlsx@latest
          go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/tomnomnom/waybackurls@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/asnmap/cmd/asnmap@latest
          # Install gowitness (public sensepost version) via Go
          go install github.com/sensepost/gowitness/cmd/gowitness@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Full Recon + Alerts
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set +e
          YEAR=$(date +%Y)
          mkdir -p data

          send_msg () {
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$1" > /dev/null
          }

          diff_alert () {
            DOMAIN="$1"
            TYPE="$2"
            TAG="$3"
            BASE="$4"

            NEW="$BASE/${TYPE}_new.txt"
            OLD="$BASE/baseline/${TYPE}.txt"

            [ ! -s "$NEW" ] && return

            mkdir -p "$BASE/baseline" "$BASE/snapshots/$YEAR"

            if [ ! -f "$OLD" ]; then
              cp "$NEW" "$OLD"
              send_msg "[$TAG] Recon Update: $DOMAIN\n\nChange Type: $TYPE\nDetected At: $(date -u)\n\nNew Findings:\n$(cat "$NEW")"
              return
            fi

            DIFF=$(comm -13 <(sort "$OLD") <(sort "$NEW"))
            [ -z "$DIFF" ] && return

            echo "$DIFF" > "$BASE/snapshots/$YEAR/${TYPE}_$(date +%H%M).txt"
            cat "$NEW" >> "$OLD"

            send_msg "[$TAG] Recon Update: $DOMAIN\n\nChange Type: $TYPE\nDetected At: $(date -u)\n\nNew Findings:\n$DIFF"
          }

          while read domain; do
            BASE="data/$domain"
            mkdir -p "$BASE/screenshots"

            # 1. Subdomains
            subfinder -d "$domain" -silent | assetfinder --subs-only | sort -u > "$BASE/sub_new.txt"
            diff_alert "$domain" sub INFO "$BASE"

            # 2. DNS + TLS
            dnsx -l "$BASE/sub_new.txt" -silent > "$BASE/dns_new.txt"
            tlsx -l "$BASE/sub_new.txt" -silent > "$BASE/tls_new.txt"
            diff_alert "$domain" dns INFO "$BASE"
            diff_alert "$domain" tls INFO "$BASE"

            # 3. Live Hosts
            httpx -l "$BASE/sub_new.txt" -silent > "$BASE/live_new.txt"
            diff_alert "$domain" live IMPORTANT "$BASE"

            # 4. IP + ASN
            dnsx -l "$BASE/live_new.txt" -resp-only | sort -u > "$BASE/ips_new.txt"
            diff_alert "$domain" ips INFO "$BASE"

            if [ -s "$BASE/ips_new.txt" ]; then
              asnmap -i "$BASE/ips_new.txt" -silent > "$BASE/asn_new.txt"
              diff_alert "$domain" asn INFO "$BASE"
            fi

            # 5. Ports
            naabu -list "$BASE/live_new.txt" -top-ports 1000 -silent > "$BASE/ports_new.txt"
            diff_alert "$domain" ports IMPORTANT "$BASE"

            # 6. Tech
            httpx -l "$BASE/live_new.txt" -tech-detect -silent > "$BASE/tech_new.txt"
            diff_alert "$domain" tech INFO "$BASE"

            # 7. URLs
            katana -list "$BASE/live_new.txt" -silent > "$BASE/urls_new.txt"
            waybackurls "$domain" >> "$BASE/urls_new.txt"
            sort -u "$BASE/urls_new.txt" -o "$BASE/urls_new.txt"
            diff_alert "$domain" urls INFO "$BASE"

            # 8. JS
            grep -iE "\.js($|\?)" "$BASE/urls_new.txt" | sort -u > "$BASE/jsfiles_new.txt" || true
            diff_alert "$domain" jsfiles INFO "$BASE"

            # 9. Params
            grep "=" "$BASE/urls_new.txt" | sort -u > "$BASE/params_new.txt" || true
            diff_alert "$domain" params INFO "$BASE"

            # 10. Admin / API
            grep -Ei "admin|api|internal|debug|staging" "$BASE/urls_new.txt" | sort -u > "$BASE/dirs_new.txt" || true
            diff_alert "$domain" dirs IMPORTANT "$BASE"

            # 11. Screenshots (only if gowitness is installed)
            if command -v gowitness >/dev/null 2>&1 && [ -s "$BASE/live_new.txt" ]; then
              gowitness scan file -f "$BASE/live_new.txt" --destination "$BASE/screenshots" >/dev/null 2>&1 || true
            fi

            # 12. Vulns
            nuclei -l "$BASE/live_new.txt" \
              -severity medium,high,critical \
              -tags cve,exposed,misconfig \
              -silent > "$BASE/vulns_new.txt" || true
            diff_alert "$domain" vulns IMPORTANT "$BASE"

          done < targets.txt


