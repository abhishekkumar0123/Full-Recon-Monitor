name: Full Recon Monitor

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  recon:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        shell: bash
        run: |
          set -e

          sudo apt update
          sudo apt install -y jq nmap libpcap-dev unzip curl

          # Go tools
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/tomnomnom/assetfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          go install github.com/projectdiscovery/tlsx/cmd/tlsx@latest
          go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/tomnomnom/waybackurls@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/asnmap/cmd/asnmap@latest

          # Gowitness â€” PREBUILT BINARY (NO GO MODULE)
          curl -L -o gowitness.zip https://github.com/sensepost/gowitness/releases/latest/download/gowitness-linux-amd64.zip
          unzip gowitness.zip
          chmod +x gowitness
          sudo mv gowitness /usr/local/bin/

          echo "$HOME/go/bin" >> "$GITHUB_PATH"

      - name: Full Recon + Alerts
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set +e
          YEAR=$(date +%Y)
          mkdir -p data

          send_msg() {
            curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
              --data-urlencode "text=$1" >/dev/null
          }

          diff_alert() {
            DOMAIN="$1"; TYPE="$2"; TAG="$3"; BASE="$4"
            NEW="$BASE/${TYPE}_new.txt"
            OLD="$BASE/baseline/${TYPE}.txt"

            [ ! -s "$NEW" ] && return
            mkdir -p "$BASE/baseline" "$BASE/snapshots/$YEAR"

            if [ ! -f "$OLD" ]; then
              cp "$NEW" "$OLD"
              send_msg "[$TAG] $DOMAIN | $TYPE\n$(date -u)\n\n$(cat "$NEW")"
              return
            fi

            sort -u "$OLD" > /tmp/old.txt
            sort -u "$NEW" > /tmp/new.txt
            DIFF=$(grep -Fxv -f /tmp/old.txt /tmp/new.txt || true)
            [ -z "$DIFF" ] && return

            echo "$DIFF" > "$BASE/snapshots/$YEAR/${TYPE}_$(date +%H%M).txt"
            cat /tmp/new.txt >> "$OLD"
            send_msg "[$TAG] $DOMAIN | $TYPE\n$(date -u)\n\n$DIFF"
          }

          while IFS= read -r domain || [ -n "$domain" ]; do
            [ -z "$domain" ] && continue
            BASE="data/$domain"
            mkdir -p "$BASE/screenshots"

            subfinder -d "$domain" -silent | assetfinder --subs-only | sort -u > "$BASE/sub_new.txt"
            diff_alert "$domain" sub INFO "$BASE"

            httpx -l "$BASE/sub_new.txt" -silent > "$BASE/live_new.txt"
            diff_alert "$domain" live IMPORTANT "$BASE"

            if command -v gowitness >/dev/null && [ -s "$BASE/live_new.txt" ]; then
              gowitness scan file -f "$BASE/live_new.txt" --destination "$BASE/screenshots" >/dev/null 2>&1
            fi

          done < targets.txt

